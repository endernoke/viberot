# Synthetic PID Implementation Notes

## Overview

VibeRot now uses a unified PID-based tracking system across all platform probes. This simplification was achieved by introducing **synthetic PIDs** for shell-based command monitoring.

## How Synthetic PIDs Work

### **Shell Probe Behavior**
- When a shell command starts, the Linux shell probe generates a **synthetic PID** starting from `1,000,000`
- This synthetic PID uniquely identifies the command session within VibeRot
- The synthetic PID is used consistently throughout the action lifecycle
- When the command ends, the same synthetic PID is used to terminate associated actions

### **PID Generation Strategy**
```rust
// Atomic counter ensures thread-safe, unique PID generation
static SYNTHETIC_PID_COUNTER: AtomicU32 = AtomicU32::new(1_000_000);

fn generate_synthetic_pid() -> u32 {
    SYNTHETIC_PID_COUNTER.fetch_add(1, Ordering::SeqCst)
}
```

### **Range Selection**
- **Synthetic PIDs**: Start at 1,000,000 and increment
- **System PIDs**: Typically range from 1 to ~32,768 (or higher on some systems)  
- **Collision Avoidance**: The 1M+ range ensures no conflicts with real system PIDs

## Environment Variables for Actions

### **VIBEROT_PID**
- **Windows ETW Probe**: Real system process ID
- **Linux Shell Probe**: Synthetic PID (1,000,000+)
- **Future Probes**: May use synthetic PIDs depending on monitoring method

### **VIBEROT_PID_TYPE**
- `"system"`: Real system process ID (Windows ETW, future eBPF)
- `"synthetic"`: Generated by VibeRot for command tracking (Shell probe)

### **Additional Context Variables**
- `VIBEROT_COMMAND`: Full command line
- `VIBEROT_TIMESTAMP`: Command start time (Unix timestamp)
- `VIBEROT_WORKING_DIRECTORY`: Working directory (shell probe only)
- `VIBEROT_SHELL_SESSION_ID`: Original shell session ID (shell probe only)

## Action Plugin Guidance

### **‚úÖ Safe Uses of VIBEROT_PID**
- **Logging and correlation**: Use PID for log messages and tracking
- **Unique identification**: PID is guaranteed unique within VibeRot session
- **File naming**: Safe to use in temporary file names or identifiers

### **‚ö†Ô∏è Unsafe Uses of VIBEROT_PID** 
- **System process queries**: Don't use `ps`, `kill`, or other system tools with synthetic PIDs
- **Process tree analysis**: Synthetic PIDs don't exist in the system process table
- **System monitoring**: Don't assume the PID corresponds to a real running process

### **üîç Detecting PID Type**
```bash
#!/bin/bash
if [ "$VIBEROT_PID_TYPE" = "synthetic" ]; then
    echo "This is a shell command with synthetic PID: $VIBEROT_PID"
    echo "Original session: $VIBEROT_SHELL_SESSION_ID"
else
    echo "This is a system process with real PID: $VIBEROT_PID"
    # Safe to use system tools like ps, pgrep, etc.
fi
```
